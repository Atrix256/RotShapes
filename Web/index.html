<html><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>RotShape Creator</title>
<style type="text/css">
body { background-color:grey;}
canvas.html5 {border:1px solid white;}
div.panel {float:left; width:33%;}
</style>
<script>

var g_sourcePanel;
var g_encodedPanel;
var g_resultPanel;
var g_mouseDown = false;
var g_brushSize = 1;

var g_color = 1;

var g_clicks = new Array();

function onPageLoaded()
{
	g_sourcePanel = setupCanvas('Source');
	g_encodedPanel = setupCanvas('Encoded');
	g_resultPanel = setupCanvas('Result');

	g_sourcePanel.elem.addEventListener('mousemove', function(evt) {OnMouseMove(evt);RedrawAll();}, false);
	g_sourcePanel.elem.addEventListener('mousedown', function(evt) {OnMouseDown(evt);RedrawAll();}, false);
	g_sourcePanel.elem.addEventListener('mouseup', function(evt) {OnMouseUp(evt);RedrawAll();}, false);
	RedrawAll();
}

function setupCanvas(name)
{
  // Get a reference to the element.
  var elem = document.getElementById(name);

  // Always check for properties and methods, to make sure your code doesn't break 
  // in other browsers.
  if (elem)
  {
    if(elem.getContext)
    {
      // Get the 2d context.
      // Remember: you can only initialize one context per element.
      var context = elem.getContext('2d');

      if (context)
      {
      	return {"elem":elem, "context":context, "clear":function(){ClearImageBuffer(context)}, "fill":function(color){FillImageBuffer(context, color)}};
      }
      else
      {
      	alert("Could not get html5 2d context, your browser doesn't support it! Try firefox or chrome");
      }
    }
    else
    {
      alert("The getContext function was missing, your browser doesn't support it! Try firefox or chrome"); 
    }
  }
  else
  {
    alert("Could not get element 'MainCanvas'");	
  }

  return false;
}

function GetMousePos(canvas, evt)
{
	var rect = g_sourcePanel.elem.getBoundingClientRect();
	var pos =
	[
		evt.clientX - rect.left,
		evt.clientY - rect.top
	];
	return pos;
}

function AddClick(mousePos, drag)
{
	g_clicks.push([mousePos, drag, g_brushSize, g_color]);
	RedrawAll();
}

function UndoSource(mousePos, drag)
{
	g_clicks.splice(-1,1);
	RedrawAll();
}

function ClearSource ()
{
	g_clicks = new Array();
	RedrawAll();
}

function ColorSource ()
{
	g_color = !g_color;
	document.getElementById('Color').value="Color: "+ (g_color ? "White" : "Black");
}

function BrushSize ()
{
	if (g_brushSize < 10)
		g_brushSize++;
	else
		g_brushSize = 1;

	document.getElementById('BrushSize').value="Brush Size: "+g_brushSize;
}

function OnMouseMove(evt)
{
	if (!g_mouseDown)
		return;

	var mousePos = GetMousePos(g_sourcePanel.elem, evt);
	AddClick(mousePos, true);
}

function OnMouseDown(evt)
{
	g_mouseDown = true;
	var mousePos = GetMousePos(g_sourcePanel.elem, evt);
	AddClick(mousePos, false);
}

function OnMouseUp(evt)
{
	g_mouseDown = false;
}

window.addEventListener('load', function(){onPageLoaded();}, false);

function ClearImageBuffer(context)
{
	context.fillStyle   = "#000000";
	context.fillRect(0, 0, g_sourcePanel.elem.width, g_sourcePanel.elem.height);
}

function FillImageBuffer(context, color)
{
	context.fillStyle   = color;
	context.fillRect(0, 0, g_sourcePanel.elem.width, g_sourcePanel.elem.height);
}

function RedrawSource()
{
	g_sourcePanel.clear();

	
	g_sourcePanel.context.lineJoin = "round";

	for(var i=0; i < g_clicks.length; ++i) {
		g_sourcePanel.context.lineWidth = g_clicks[i][2];  
		g_sourcePanel.context.beginPath();

		g_sourcePanel.context.strokeStyle=g_clicks[i][3]?'#FFFFFF':'#000000';

		if(g_clicks[i][1] && i > 0) {
			g_sourcePanel.context.moveTo(g_clicks[i-1][0][0], g_clicks[i-1][0][1]);
		}
		else {
			g_sourcePanel.context.moveTo(g_clicks[i][0][0], g_clicks[i][0][1])
		}

		g_sourcePanel.context.lineTo(g_clicks[i][0][0], g_clicks[i][0][1]);
		g_sourcePanel.context.closePath();
		g_sourcePanel.context.stroke();
	}
}

function ResizeCanvases ()
{
	g_sourcePanel.elem.width = document.getElementById('SourceWidth').value;
	g_sourcePanel.elem.height = document.getElementById('SourceHeight').value;

	g_encodedPanel.elem.height = document.getElementById('EncodedHeight').value;

	g_resultPanel.elem.width = document.getElementById('ResultWidth').value;
	g_resultPanel.elem.height = document.getElementById('ResultHeight').value;	

	RedrawAll();
}

function RedrawEncoded ()
{
	g_encodedPanel.clear();
	FillImageBuffer(g_encodedPanel.context, "#A0B0F0");
}

function RedrawResult ()
{
	// clear the panel
	g_resultPanel.clear();

	// get the encoded image data
	var encodedWidth = g_encodedPanel.elem.width;
	var encodedHeight = g_encodedPanel.elem.height;
	var encodedData = g_encodedPanel.context.getImageData(0,0,encodedWidth,encodedHeight);

	// make image data for the result data
	var resultWidth = g_resultPanel.elem.width;
	var resultHeight = g_resultPanel.elem.height;
	var resultData = g_resultPanel.context.createImageData(resultWidth,resultHeight);

	// make the result
	for (y = 0; y < resultHeight; ++y) {
		for (x = 0; x < resultWidth; ++x) {

			// calculate the x,y distance of this pixel from the center of the image, in -1,+1 range
			var normDistX = (x - (resultWidth/2))/(resultWidth/2);
			var normDistY = (y - (resultHeight/2))/(resultHeight/2);

			// calculate the positive angle in radians, then into percentage where 0 to 1 equals 0 to 2pi
			// then take that percentage and map it to which pixel row should be read from the encoded image
			var normAngle = Math.atan2(normDistY,normDistX);
			if (normAngle < 0)
				normAngle += Math.PI * 2;
			normAngle /= Math.PI*2;
			normAngle = Math.floor(normAngle * encodedHeight);

			// read the squared distance for that angle from our encoded image, only first frame for now
			// and make it into the 0 to 1 range
			var encodedDistSq1 = encodedData.data[((encodedWidth)*normAngle)*4+0] / 255;
			var encodedDistSq2 = encodedData.data[((encodedWidth)*normAngle)*4+1] / 255;
			var encodedDistSq3 = encodedData.data[((encodedWidth)*normAngle)*4+2] / 255;
			var encodedDistSq4 = encodedData.data[((encodedWidth)*normAngle)*4+3] / 255;

			// calculate squared distance
			var distSq = normDistX*normDistX + normDistY*normDistY;

			// figure out whether we are inside the shape or not
			var fillValue = 0;
			if (distSq < encodedDistSq1)
				fillValue = 0;
			else if (distSq < encodedDistSq2)
				fillValue = 255;
			else if (distSq < encodedDistSq3)
				fillValue = 0;
			else if (distSq < encodedDistSq4)
				fillValue = 255;
			else
				fillValue = 0;

			// write to the pixel: R,G,B,A
			resultData.data[((resultWidth*y)+x)*4+0] = fillValue;
			resultData.data[((resultWidth*y)+x)*4+1] = fillValue;
			resultData.data[((resultWidth*y)+x)*4+2] = fillValue;			
			resultData.data[((resultWidth*y)+x)*4+3] = 255;
		}
	}

    // draw the result
	g_resultPanel.context.putImageData(resultData,0,0);
}

function RedrawAll ()
{
	RedrawEncoded();
	RedrawSource();
	RedrawResult();
}

</script>
</head>
<body>

<h1>RotShape Creator</h1>

<div class="panel">
<canvas class="html5" id="Source" width="256" height="256">Your browser doesn't seem to support the necesary html5 features ):</canvas>
<br>
Source:<input type="text" id="SourceWidth" value="256" style="width:4em"/>x<input type="text" id="SourceHeight" value="256" style="width:4em"/>
<input type=button value="Resize" onClick="ResizeCanvases()"/>
<br>
<input type=button id="BrushSize" value="Brush Size: 1" onClick="BrushSize()"/>
<input type=button id="Color" value="Color: White" onClick="ColorSource()"/>
<input type=button value="Undo" onClick="UndoSource()"/>
<input type=button value="Clear" onClick="ClearSource()"/>
</div>

<div class="panel">
<canvas class="html5" id="Encoded" width="10" height="256">Your browser doesn't seem to support the necesary html5 features ):</canvas>
<br/>
Encoded:<input type="text" id="EncodedHeight" value="256" style="width:4em"/>
<input type=button value="Resize" onClick="ResizeCanvases()"/>
</div>

<div class="panel">
<canvas class="html5" id="Result" width="256" height="256">Your browser doesn't seem to support the necesary html5 features ):</canvas>
<br/>
Result:<input type="text" id="ResultWidth" value="256" style="width:4em"/>x<input type="text" id="ResultHeight" value="256" style="width:4em"/>
<input type=button value="Resize" onClick="ResizeCanvases()"/>
</div>

</body>
</html>